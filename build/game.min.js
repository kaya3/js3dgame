var __extends=this&&this.__extends||function(){var a=function(d,c){a=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,a){d.__proto__=a}||function(d,a){for(var c in a)a.hasOwnProperty(c)&&(d[c]=a[c])};return a(d,c)};return function(d,c){function b(){this.constructor=d}a(d,c);d.prototype=null===c?Object.create(c):(b.prototype=c.prototype,new b)}}(),Util=function(){function a(){}a.limitNumberRange=function(d,a,b){return Math.min(b,Math.max(a,d))};a.isNumberInRangeExclusive=function(d,
a,b){return d>a&&d<b};a.isNumberInRangeInclusive=function(d,a,b){return d>=a&&d<=b};a.isIntersecting=function(d,a,b,e,f,g){return e>a!=g>a&&d<(f-b)*(a-e)/(g-e)+b};a.isPointInPolygon=function(d,c){for(var b=!1,e=0,f=d.length-1;e<d.length;f=e++)a.isIntersecting(c.x,c.y,d[e].x,d[e].y,d[f].x,d[f].y)&&(b=!b);return b};return a}(),Camera=function(){function a(){this.y=this.x=this.halfHeight=this.halfWidth=this.tlY=this.tlX=0;this.scale=1}a.prototype.resizeWindow=function(d,a){this.halfWidth=d/2;this.halfHeight=
a/2;this.moveTo(0,0)};a.prototype.moveTo=function(d,a){this.x=d;this.y=a;this.tlX=this.halfWidth-d;this.tlY=this.halfHeight-a};a.prototype.translate=function(d,a){this.moveTo(this.x+d,this.y+a)};a.prototype.setTransform=function(d){d.setTransform(this.scale,0,0,this.scale,this.tlX,this.tlY)};return a}(),sqrt2=Math.sqrt(2),sqrt3=Math.sqrt(3),sqrt6=Math.sqrt(6),Vector3=function(){function a(d,a,b){this.x=d;this.y=a;this.z=b}a.prototype.add=function(d){return new a(this.x+d.x,this.y+d.y,this.z+d.z)};
a.prototype.subtract=function(d){return new a(this.x-d.x,this.y-d.y,this.z-d.z)};a.prototype.lengthSquared=function(){return this.x*this.x+this.y*this.y+this.z*this.z};a.prototype.length=function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)};a.prototype.scale=function(d){return new a(d*this.x,d*this.y,d*this.z)};a.prototype.unit=function(){return this.scale(1/this.length())};a.prototype.dot=function(d){return this.x*d.x+this.y*d.y+this.z*d.z};a.prototype.cross=function(d){return new a(this.y*
d.z-this.z*d.y,this.z*d.x-this.x*d.z,this.x*d.y-this.y*d.x)};a.prototype.project2d=function(){return new Vector2(2*CAMERA_SCALE*(this.x+this.y),CAMERA_SCALE*(this.y-this.x-sqrt6*this.z))};a.prototype.cameraOrder=function(){return sqrt3*(this.x-this.y)+sqrt2*this.z};a.prototype.equals=function(d,a){void 0===a&&(a=1E-5);return this.subtract(d).isZero(a)};a.prototype.isZero=function(d){void 0===d&&(d=1E-5);return Math.abs(this.x)<d&&Math.abs(this.y)<d&&Math.abs(this.z)<d};a.ZERO=new a(0,0,0);a.X_UNIT=
new a(1,0,0);a.Y_UNIT=new a(0,1,0);a.Z_UNIT=new a(0,0,1);return a}(),Vector2=function(){function a(d,a){this.x=d;this.y=a}a.prototype.add=function(d){return new a(this.x+d.x,this.y+d.y)};a.prototype.subtract=function(d){return new a(this.x-d.x,this.y-d.y)};a.prototype.scale=function(d){return new a(d*this.x,d*this.y)};a.prototype.dot=function(d){return this.x*d.x+this.y*d.y};a.prototype.equals=function(d,a){void 0===a&&(a=1E-10);return Math.abs(this.x-d.x)<a&&Math.abs(this.y-d.y)<a};return a}(),Polygon3=
function(){function a(d,a,b){this.points=d;this.texture=a;this.isWalkable=b;a=this.normal=d[1].subtract(d[0]).cross(d[2].subtract(d[1])).unit();b=a.cross(Vector3.Z_UNIT);this.u=b=b.isZero()?Vector3.X_UNIT:b.unit();this.v=a.cross(b).unit();a=d[0].cameraOrder();for(b=1;b<d.length;++b)a=Math.min(d[b].cameraOrder(),a);this.cameraOrder=-a;this.xyBoundingBox=new BoundingBox2(d)}a.prototype.project2d=function(){return new Polygon2(this.points.map(function(a){return a.project2d()}),this)};a.prototype.projectZ=
function(a,c){var b=this.normal;return(b.dot(this.points[0])-a*b.x-c*b.y)/b.z};a.prototype.contains=function(a){return this.xyBoundingBox.contains(a)&&Util.isPointInPolygon(this.points,a)};return a}(),Polygon2=function(){function a(a,c){this.points=a;this.as3d=c;this.boundingBox=new BoundingBox2(a);var b=c.u.project2d(),e=c.v.project2d(),f=a[0];this.uvTransform=new UVTransform(b.x,b.y,e.x,e.y,f.x,f.y)}a.prototype.drawPath=function(a){var c=this.points;a.beginPath();var b=c[0];a.moveTo(b.x,b.y);for(var e=
1;e<c.length;++e)b=c[e],a.lineTo(b.x,b.y);a.closePath()};a.prototype.contains=function(a){return this.boundingBox.contains(a)&&Util.isPointInPolygon(this.points,a)};return a}(),BoundingBox2=function(){function a(a){for(var c=a[0],b=c.x,e=c.y,f=c.x,c=c.y,g=1;g<a.length;++g)c=a[g],b=Math.min(b,c.x),e=Math.min(b,c.y),f=Math.max(b,c.x),c=Math.max(b,c.y);this.left=b;this.top=e;this.right=f;this.bottom=c}a.prototype.contains=function(a){return this.left<=a.x&&a.x<=this.right&&this.top<=a.y&&a.y<=this.bottom};
return a}(),CAMERA_SCALE=64,Renderer=function(){function a(a){this.images=a;this.textures=Object.create(null);var c=this.canvas=document.createElement("canvas"),b=this.ctx=c.getContext("2d");b.lineCap="round";b.lineJoin="round";b.strokeStyle="gray";b.lineWidth=1;var e=this.lightCanvas=document.createElement("canvas");this.lightCtx=e.getContext("2d");for(var f in a){var g=f;this.textures[g]=b.createPattern(a[g],"repeat")}a=document.getElementsByTagName("body")[0];a.appendChild(c);a.appendChild(e);
e.style.display="none"}a.prototype.resizeWindow=function(a,c){this.canvas.width=this.lightCanvas.width=a;this.canvas.height=this.lightCanvas.height=c};a.prototype.draw=function(a,c){var b=this,e=a.camera,f=a.scene.as3d,g=a.npcs,h=this.ctx,k=this.lightCtx,l=this.canvas.width,m=this.canvas.height;h.globalCompositeOperation="source-over";h.fillStyle=f.data.backgroundColor.toString();h.fillRect(0,0,l,m);k.globalCompositeOperation="source-over";k.setTransform(1,0,0,1,0,0);k.fillStyle=f.ambientLightColor.toString();
k.fillRect(0,0,l,m);k.globalCompositeOperation="lighter";k=a.scene.polygons;for(l=0;l<k.length;++l)m=k[l],this.drawPolygon(m,e),this.lightPolygon(m,f.staticLights,e),c&&this.lightPolygon(m,f.dynamicLights,e);this.drawSprite(h,a.player,e);this.lightSprite(a.player,e);this.drawSprite(h,a.npc,e);this.drawSprite(h,a.item,e);g.forEach(function(a){return b.drawSprite(h,a,e)});h.globalCompositeOperation="multiply";h.setTransform(1,0,0,1,0,0);h.drawImage(this.lightCanvas,0,0);this.drawLights(f.staticLights,
e);c&&this.drawLights(f.dynamicLights,e)};a.prototype.drawSprite=function(a,c,b){var e=this.images[c.sprite],f=e.width,g=e.height,h=f*b.scale*SPRITE_SCALE;b=g*b.scale*SPRITE_SCALE;c=c.pos.project2d();a.drawImage(e,0,0,f,g,c.x-h/2,c.y-b,h,b)};a.prototype.lightSprite=function(a,c){this.lightCtx.globalCompositeOperation="destination-out";this.drawSprite(this.lightCtx,a,c)};a.prototype.drawPolygon=function(a,c){var b=this.ctx;c.setTransform(b);a.drawPath(b);a.uvTransform.apply(b,c,TEXTURE_SCALE);b.fillStyle=
this.textures[a.as3d.texture];b.fill();c.setTransform(b);b.stroke()};a.prototype.lightPolygon=function(a,c,b){for(var e=this.lightCtx,f=0;f<c.length;++f)c[f].drawForPolygon(e,b,a)};a.prototype.drawLights=function(a,c){for(var b=0;b<a.length;++b)a[b].drawForCamera(this.ctx,c)};return a}(),TEXTURES={wall:"textures/wall-bricks.jpg",floor:"textures/floor-tiles.jpg",stick_figure:"textures/figure.png",npc:"textures/goose_left.png",item:"textures/bed.png"},TEXTURE_SCALE=0.005,SPRITE_SCALE=2,UVTransform=
function(){function a(a,c,b,e,f,g){this.a=a;this.b=c;this.c=b;this.d=e;this.x=f;this.y=g}a.prototype.apply=function(a,c,b){void 0===b&&(b=1);b*=c.scale;a.setTransform(b*this.a,b*this.b,b*this.c,b*this.d,this.x+c.tlX,this.y+c.tlY)};return a}();
function loadTextures(a){var d=Object.create(null),c=0,b;for(b in TEXTURES)if(Object.hasOwnProperty.call(TEXTURES,b)){var e=new Image;e.src=TEXTURES[b];e.style.display="none";++c;e.onload=function(){0==--c&&a(d)};d[b]=e}for(b in d)document.getElementsByTagName("body")[0].appendChild(d[b])}
var Scene3=function(){function a(a){this.data=a;this.polygons=a.faces.map(function(a){return new Polygon3(a.coords,a.texture,a.isWalkable)});var c=a.lights.filter(function(a){return"ambient"===a.kind})[0];this.ambientLightColor=c?c.color:Color.greyscale(0);this.staticLights=a.lights.filter(function(a){return"static"===a.kind});this.dynamicLights=a.lights.filter(function(a){return"dynamic"===a.kind})}a.prototype.project2d=function(){return new Scene2(this.polygons.map(function(a){return a.project2d()}),
this)};a.prototype.addDynamicLight=function(a){if("dynamic"!==a.kind)throw Error("Cannot add "+a.kind+" light dynamically");this.dynamicLights.push(a)};return a}(),Scene2=function(){return function(a,d){this.as3d=d;this.polygons=a.sort(function(a,d){return a.as3d.cameraOrder-d.as3d.cameraOrder})}}(),Color=function(){function a(a,c,b){this.r=a;this.g=c;this.b=b}a.greyscale=function(d){return new a(d,d,d)};a.rgb=function(d,c,b){return new a(d,c,b)};a.prototype.toString=function(a){void 0===a&&(a=1);
var c=this.r,b=this.g,e=this.b;a=Math.min(a,1);return["rgba(",c,",",b,",",e,",",a,")"].join("")};return a}(),AmbientLight=function(){function a(a){this.color=a;this.kind="ambient"}a.prototype.drawForPolygon=function(a,c,b){throw Error("Ambient light should not be drawn per-polygon");};a.prototype.drawForCamera=function(a,c){throw Error("Ambient light should not be drawn per-polygon");};return a}(),DirectionalLight=function(){function a(a,c){this.color=c;this.kind="static";this.direction=a.unit()}
a.prototype.drawForPolygon=function(a,c,b){var e=-b.as3d.normal.dot(this.direction);0<e&&(c.setTransform(a),b.drawPath(a),a.fillStyle=this.color.toString(e),a.fill())};a.prototype.drawForCamera=function(a,c){};return a}(),PointLight=function(){function a(a,c,b,e){this.pos=a;this.color=c;this.intensity=b;this.kind=e}a.prototype.drawForPolygon=function(a,c,b){var e=b.as3d.normal,f=b.as3d.points[0],g=this.pos.subtract(f).dot(e)+0.015625;0<=g&&10>g&&(f=this.pos.subtract(e.scale(g)).subtract(f),e=b.as3d.u.dot(f),
f=b.as3d.v.dot(f),c.setTransform(a),b.drawPath(a),b.uvTransform.apply(a,c),a.fillStyle=this.makeGradient(a,e,f,g,10,1),a.fill())};a.prototype.drawForCamera=function(a,c){var b=this.pos.project2d(),e=b.x,b=b.y,f=128*c.scale;c.setTransform(a);a.globalCompositeOperation="lighter";a.fillStyle=this.makeGradient(a,e,b,0.1,f,f/1024);a.fillRect(e-f,b-f,2*f,2*f)};a.prototype.makeGradient=function(a,c,b,e,f,g){a=a.createRadialGradient(c,b,0,c,b,f);c=e*e;for(b=0;10>b;++b){var h=b*b/100,k=f*h*g,k=Math.pow(c+
k*k,1.5);a.addColorStop(h,this.color.toString(this.intensity*e/(k+1E-5)))}a.addColorStop(1,this.color.toString(0));return a};return a}(),Sprite=function(){function a(a,c){this.pos=a;this.sprite=c;this.onMoveCallbacks=[]}a.prototype.setPos=function(a){this.pos=a;for(var c=this.onMoveCallbacks,b=0;b<c.length;++b)c[b](a)};a.prototype.onMove=function(a){this.onMoveCallbacks.push(a)};return a}(),Player=function(a){function d(){return null!==a&&a.apply(this,arguments)||this}__extends(d,a);return d}(Sprite),
NPC=function(a){function d(c,b){var d=a.call(this,c,b)||this;d.pos=c;d.sprite=b;d.dx=d.dy=0;d.updateDirection();return d}__extends(d,a);d.prototype.randomSpeed=function(){return Math.random()*Game.NPC_SPEED/2+Game.NPC_SPEED};d.prototype.updateDirection=function(){this.dx=this.randomSpeed();this.dy=this.randomSpeed();var a=Math.random();0.1>a?this.dx*=2:0.2>a?this.dy*=2:0.4>a?this.dx*=3:0.5>a&&(this.dy*=3);0.5>a?this.dx*=-1:this.dy*=-1};return d}(Sprite),Item=function(a){function d(d,b){var e=a.call(this,
d,b)||this;e.pos=d;e.sprite=b;return e}__extends(d,a);return d}(Sprite),SCENE_DATA=function(){function a(a,c,b){return new Vector3(a,c,b)}return{faces:[{label:"C",isWalkable:!0,texture:"floor",coords:[a(0,0,0),a(6,0,0),a(6,10,0),a(0,10,0)]},{label:"A",isWalkable:!1,texture:"wall",coords:[a(0,0,0),a(0,0,1),a(6,0,1),a(6,0,0)]},{label:"B",isWalkable:!1,texture:"wall",coords:[a(6,10,1),a(6,10,0),a(6,0,0),a(6,0,1)]},{label:"D",isWalkable:!1,texture:"wall",coords:[a(0,0,0),a(0,0,1),a(0,10,1),a(0,10,0)]},
{label:"E",isWalkable:!1,texture:"wall",coords:[a(0,10,0),a(0,10,1),a(2,10,1),a(2,10,0)]},{label:"F",isWalkable:!1,texture:"wall",coords:[a(4,10,0),a(4,10,1),a(6,10,1),a(6,10,0)]},{label:"O",isWalkable:!0,texture:"floor",coords:[a(2,10,0),a(4,10,0),a(4,15,2.5),a(2,15,2.5)]},{label:"G",isWalkable:!1,texture:"wall",coords:[a(4,10,0),a(4,10,1),a(4,15,2.5),a(4,15,1)]},{label:"H",isWalkable:!1,texture:"wall",coords:[a(2,10,0),a(2,10,1),a(2,15,2.5),a(2,15,0)]},{label:"N",isWalkable:!0,texture:"floor",coords:[a(-4,
15,2.5),a(6,15,2.5),a(6,23,2.5),a(-4,23,2.5),a(-4,20,2.5),a(-1,20,2.5),a(-1,18,2.5),a(-4,18,2.5)]},{label:"I",isWalkable:!1,texture:"wall",coords:[a(-4,15,0),a(-4,15,2.5),a(2,15,2.5),a(2,15,0)]},{label:"K",isWalkable:!1,texture:"wall",coords:[a(-4,23,0),a(-4,23,2.5),a(6,23,2.5),a(6,23,0)]},{label:"L",isWalkable:!1,texture:"wall",coords:[a(6,15,0),a(6,15,2.5),a(6,23,2.5),a(6,23,0)]},{label:"M",isWalkable:!1,texture:"wall",coords:[a(4,15,0),a(4,15,2.5),a(6,15,2.5),a(6,15,0)]},{isWalkable:!1,texture:"wall",
coords:[a(-4,15,1),a(-4,15,2.5),a(-4,18,2.5),a(-4,18,1)]},{isWalkable:!1,texture:"wall",coords:[a(-4,20,1),a(-4,20,2.5),a(-4,23,2.5),a(-4,23,1)]},{isWalkable:!0,texture:"floor",coords:[a(-4,18,1),a(-1,18,2.5),a(-1,20,2.5),a(-4,20,1)]},{isWalkable:!1,texture:"wall",coords:[a(-4,18,1),a(-4,18,2.5),a(-1,18,2.5)]},{isWalkable:!1,texture:"wall",coords:[a(-4,20,1),a(-1,20,2.5),a(-4,20,2.5)]},{isWalkable:!0,texture:"floor",coords:[a(-4,15,1),a(-4,23,1),a(-12,23,1),a(-12,15,1)]}],lights:[new AmbientLight(Color.greyscale(10)),
new DirectionalLight(new Vector3(3,-1,5),Color.rgb(50,60,40))],playerStartPos:a(5,2,0),playerSprite:"stick_figure",npcStartPos:a(5,4,0),npcSprite:"npc",itemStartPos:a(5,4,0),itemSprite:"item",backgroundColor:Color.rgb(48,200,48),numGeese:140}}(),KEYCODE_PAGE_UP=33,KEYCODE_PAGE_DOWN=34,KEYCODE_Q=81,KEYCODE_E=69,KEYCODE_W=87,KEYCODE_A=65,KEYCODE_S=83,KEYCODE_D=68,KEYCODE_ARROW_LEFT=37,KEYCODE_ARROW_RIGHT=39,KEYCODE_ARROW_UP=38,KEYCODE_ARROW_DOWN=40,PLAYER_UP=KEYCODE_ARROW_UP,PLAYER_DOWN=KEYCODE_ARROW_DOWN,
PLAYER_RIGHT=KEYCODE_ARROW_RIGHT,PLAYER_LEFT=KEYCODE_ARROW_LEFT,CAMERA_UP=KEYCODE_W,CAMERA_DOWN=KEYCODE_S,CAMERA_RIGHT=KEYCODE_D,CAMERA_LEFT=KEYCODE_A,ZOOM_IN=KEYCODE_PAGE_UP,ZOOM_DOWN=KEYCODE_PAGE_DOWN,Game=function(){function a(a){this.scene=a;this.player=new Player(Vector3.ZERO,a.as3d.data.playerSprite);this.npc=new NPC(new Vector3(2.5,17,0),a.as3d.data.npcSprite);this.item=new Item(new Vector3(2.3,4,0),a.as3d.data.itemSprite);var c=this.camera=new Camera;this.player.onMove(function(a){a=a.project2d();
c.moveTo(a.x,a.y)});var b=this.playerLight=new PointLight(Vector3.ZERO,Color.rgb(255,255,200),1,"dynamic");this.scene.as3d.addDynamicLight(b);var e=new Vector3(0.105,0.105,0.452);this.player.onMove(function(a){return b.pos=a.add(e)});this.player.setPos(a.as3d.data.playerStartPos);this.npcs=[];for(var f=0;f<a.as3d.data.numGeese;f++)this.npcs[f]=new NPC(a.as3d.data.playerStartPos,a.as3d.data.npcSprite)}a.prototype.tick=function(d,c){var b=d*a.CAMERA_SPEED;this.camera.translate((c[CAMERA_RIGHT]-c[CAMERA_LEFT])*
b,(c[CAMERA_DOWN]-c[CAMERA_UP])*b);this.handleKeyPresses(d,c);this.moveNpcs();b=this.playerLight.intensity+(Math.random()-0.5)*d/64;this.playerLight.intensity=Util.limitNumberRange(b,0.8,1.2)};a.prototype.moveNpcs=function(){var a=this;this.npcs.forEach(function(c){a.moveSpriteWithinBounds(c,c.dx,c.dy)||c.updateDirection()})};a.prototype.handleKeyPresses=function(d,c){this.camera.scale=Util.limitNumberRange(this.camera.scale*(1+a.CAMERA_ZOOM_SPEED*(c[ZOOM_IN]-c[ZOOM_DOWN])*d),a.MIN_ZOOM,a.MAX_ZOOM);
var b=a.PLAYER_SPEED*d;this.moveSpriteWithinBounds(this.player,(c[PLAYER_RIGHT]-c[PLAYER_LEFT]-c[PLAYER_DOWN]+c[PLAYER_UP])*b,(c[PLAYER_RIGHT]-c[PLAYER_LEFT]+c[PLAYER_DOWN]-c[PLAYER_UP])*b)};a.prototype.moveSpriteWithinBounds=function(a,c,b){c=a.pos.x+c;b=a.pos.y+b;var e=this.findFloorsByXY(c,b);if(!e.length)return!1;for(var f=a.pos.z,g=e[0].projectZ(c,b),h=1;h<e.length;++h){var k=e[h].projectZ(c,b);Math.abs(k-f)<Math.abs(g-f)&&(g=k)}a.setPos(new Vector3(c,b,g));return!0};a.prototype.findFloorsByXY=
function(a,c){var b=new Vector3(a,c,0);return this.scene.as3d.polygons.filter(function(a){return a.isWalkable&&Util.isPointInPolygon(a.points,b)})};a.CAMERA_SPEED=0.4;a.CAMERA_ZOOM_SPEED=0.001;a.MAX_ZOOM=4;a.MIN_ZOOM=0.25;a.PLAYER_SPEED=0.002;a.NPC_SPEED=0.08;return a}();
function main(a){var d=(new Scene3(a)).project2d(),c=Object.create(null);for(a=0;256>a;++a)c[a]=0;window.addEventListener("keydown",function(a){c[a.keyCode]=1});window.addEventListener("keyup",function(a){c[a.keyCode]=0});loadTextures(function(a){function e(){var a=window.innerWidth,b=window.innerHeight;g.camera.resizeWindow(a,b);h&&h.resizeWindow(a,b)}function f(a){a&&k&&g.tick(a-k,c);k=a;h.draw(g,!0);window.requestAnimationFrame(f)}var g=new Game(d),h=new Renderer(a);g.camera.translate(500,0);window.addEventListener("resize",
e);e();var k;f()})};
